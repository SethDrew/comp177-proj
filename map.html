
<!DOCTYPE html>
<meta charset="utf-8">
<head>
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/mapstyle.css" rel="stylesheet" type="text/css">



<script src="js/d3.v4.min.js"></script>
<script src="js/topojson.v1.min.js"></script>
<script src="js/jquery-3.1.0.min.js"></script>
</head>
<html>
<h1></h1>
<span id="range">Aug 2015</span><input id="slider" class="slider" type="range" min="0" max="12" value="0" step="1" />
</br>
<div class="[ form-group ]">
<input type="checkbox" name="show_plant_checkbox" id="show_plant_checkbox" onchange="toggle_plants()" checked/>
            <div class="[ btn-group ]">
                <label for="show_plant_checkbox" class="[ btn btn-default ]">
                    <span class="[ glyphicon glyphicon-ok ]"></span>
                    <span>Â </span>
                </label>
                <label for="show_plant_checkbox" class="[ btn btn-default active ]">
                    Show Plants
                </label>
            </div>
            </div>



<script>
  $(document).ready(function(){
        // add button style 
      // Add button style with alignment to left with margin.
      
      //loop 
      $("[name='poll_bar'").each(
          function(i){      
            //get poll value  
            var bar_width = (parseFloat($("[name='poll_val'").eq(i).text())/2).toString();          
            bar_width = bar_width + "%"; //add percentage sign.                   
            //set bar button width as per poll value mention in span.
            $("[name='poll_bar'").eq(i).width(bar_width);         
            
      });
  });
</script>
<div>

<div style="float:left">
<svg width="960" height="600"></svg>
</div>
<div class="panel panel-primary" style="float: left; width:30%; margin:20px" >
    <div class="panel-heading">
    <h3 class="panel-title">
      Total Energy Output per Fuel Type (clickable)
    </h3>    
  </div>     
  <div class="panel-body"  style="margin:0px; width:100%;">
    
    <div id="TotalEnergyPanel"> 
    </div>

    
  </div>  
</div>


</div>
<script>
var dates = ["Aug 2015", "Sep 2015", "Oct 2015", "Nov 2015", "Dec 2015", "Jan 2016", "Feb 2016", "Mar 2016","Apr 2016" , "May 2016", "Jun 2016", "Jul 2016", "Aug 2016"];
var showing_plants = true;
var energy_type_names = {
  SUN : "Solar and Thermal",
  COL : "Coal",
  DFO : "Distillate Petroleum",
  GEO : "Geothermal",
  HPS : "Hydroelectric Pumped Storage",
  HYC : "Hydroelectric Conventional",
  MLG : "Biogenic Municipal Solid Waste and Landfill Gas",
  NG  : "Natural Gas",
  NUC : "Nuclear",
  OOG : "Other Gases",
  ORW : "Other Renewables ",
  OTH : "Other (including nonbiogenic MSW)",
  PC  : "Petroleum Coke",
  RFO : "Residual Petroleum",
  WND : "Wind",
  WOC : "Waste Coal",
  WOO : "Waste Oil",
  WWW : "Wood and Wood Waste"
};

var energy_type_colors = {
  SUN : d3.color("gold"),
  COL : d3.color("darkgray"),
  DFO : d3.color("black"),
  GEO : d3.color("green"),
  HPS : d3.color("royalblue"),
  HYC : d3.color("royalblue"),
  MLG : d3.color("lightsalmon"), // natural gasses
  NG  : d3.color("lightsalmon"), // natural gasses
  NUC : d3.color("red"),
  OOG : d3.color("lightsalmon"), 
  ORW : d3.color("darkolivegreen"),
  OTH : d3.color("darkolivegreen"),
  PC  : d3.color("black"),
  RFO : d3.color("black"),
  WND : d3.color("white"),
  WOC : d3.color("darkgray"),
  WOO : d3.color("black"),
  WWW : d3.color("brown")
};
var energy_type_toggles = {
  SUN : true,
  COL : true,
  DFO : true,
  GEO : true,
  HPS : true,
  HYC : true,
  MLG : true,
  NG  : true,
  NUC : true,
  OOG : true,
  ORW : true,
  OTH : true,
  PC  : true,
  RFO : true,
  WND : true,
  WOC : true,
  WOO : true,
  WWW : true

};

function toggle_plants()
{
    if($('#show_plant_checkbox').is(":checked")){
        d3.selectAll(".plant").style("opacity", 1);
        showing_plants = true;
      }
    else{
        d3.selectAll(".plant").style("opacity", 0);
      showing_plants = false;
    }
}
function toggle_plants_bytype(keys)
{
  keys.forEach(function(key){
      if(energy_type_toggles[key] == true){
        d3.selectAll("."+key).style("opacity", 0);
        d3.selectAll("."+key+"-table").style("opacity", .5);
        energy_type_toggles[key] = false;
      }
      else{
        d3.selectAll("."+key).style("opacity", 1);
        d3.selectAll("."+key+"-table").style("opacity", 1);
        energy_type_toggles[key] = true


      }

    });
}

var title = d3.select("h1")
    .text("US Energy Information Administration Dataset");

var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");

var priceByState = d3.map();

var color = d3.scaleLinear()
    .domain([0, 30])
    .range(["steelblue","brown"]);


var quantize_color = d3.scaleQuantize()
    .domain([8, 20])
    .range(d3.range(30).map(function(i) { return color(i); }));

var projection = d3.geoAlbersUsa()
    .scale(1280)
    .translate([width / 2, height / 2]);

var path = d3.geoPath()
    .projection(projection);

d3.queue()
    .defer(d3.json, "js/us.json")
    .defer(d3.csv, "tsv/price.csv", function(d) { priceByState.set(d.id, [d.a, d.b, d.c, d.d, d.e, d.f, d.g, d.h, d.i, d.j, d.k, d.l, d.m]);})
    .defer(d3.json, "tsv/plants.json")
    .defer(d3.json, "tsv/totalenergy.json")
    .await(ready);

function ready(error, us, price, plants, total_energy) {
  //deleting drought argument removes plants
  if (error) throw error;

  svg.append("g")
      .attr("class", "states")
    .selectAll("path")
      .data(topojson.feature(us, us.objects.states).features)
    .enter().append("path")
      .attr("fill", function(d) {var i = [].concat.apply([], priceByState.get(d.id)); return quantize_color(i[0]); })
      .attr("d", path)
      .on('mouseover', function(d) {
        var currentState = this;
        d3.select(this).style('fill-opacity', 0.7);
      })
      .on('mouseout', function(d) {
        var currentState = this;
        d3.select(this).style('fill-opacity', 1);
      });

    console.log(plants)

  /* add plant dots */
  plants.forEach(function(c){
    var outputs = Object.values(c.output)

    var sum_outputs = outputs.reduce(function(a, b) { return a + b; }, 0);
    if(sum_outputs < 0 || sum_outputs == NaN){
        sum_outputs = 0
    }
    svg.append("circle")
      .attr("id", c.name)
      .attr("class", "plant "+c.aer_fuel_type[0])
      .attr("r",Math.sqrt(sum_outputs)/700)
      .attr("fill", energy_type_colors[c.aer_fuel_type[0]]) // todo: max value here instead of just first one
      .attr("transform", function() {return "translate(" + projection([c.lon, c.lat]) + ")";})
      .text(function(d){

        return energy_type_names[c.name]})
     
  });

  d3.select("#slider").on("input", function() {
    var i = +this.value;
    d3.select('#range').text(dates[i]);

    svg.selectAll("path").each(function(d) {
        console.log(priceByState.get(d.id));
        this.style.fill = quantize_color([].concat.apply(priceByState.get(d.id))[i]);
    });
  });

  total_energy.sort(
    function(x, y){
      return x.total > y.total ? 1 : -1
    }).reverse();

  var most_energy = total_energy[0].total;
  d3.select("#TotalEnergyPanel").selectAll("div")
        .data(total_energy).enter()
        .append("div")
        .text(function(d) {return d.name})
        .append("div")
        .attr("class", function(d) {return d.key+"-table btn"})
        .style("background", function(d) {return energy_type_colors[d.key]})
        .style("padding", "10px")
        .style("border", "black")
         .style("-moz-border-radius", "6px 6px 6px 6px")
         .style("border-radius", "6px 6px 6px 6px" )
         .style("border", function(d){ if(d.name == "Wind"){return "2px solid black"} else{return ""}})
         .style("width", function(d){var result = Math.sqrt(d.total / most_energy) * 100; console.log(result); return result.toString() + "%"})
        // .text(function(d) {return d.name + ": "+d.total.toExponential()+" MWH"})

        .on("click", function(d){
            toggle_plants_bytype(d.keys)
        })


}


</script>

</html>
